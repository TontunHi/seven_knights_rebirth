<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../partials/head') %>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        body { background-color: #0f0f0f; font-family: 'Segoe UI', sans-serif; }
        
        /* --- Filters & Card Styles --- */
        .filter-container { display: flex; justify-content: center; gap: 15px; margin-bottom: 40px; }
        .filter-btn {
            background: #1a1a1a; border: 1px solid #333; color: #888;
            padding: 8px 25px; border-radius: 25px; cursor: pointer; transition: all 0.3s;
            font-weight: 600; letter-spacing: 0.5px;
        }
        .filter-btn:hover { color: #fff; border-color: #666; }
        .filter-btn.active { color: #000; border-color: transparent; transform: scale(1.05); }
        
        .filter-btn[data-filter="all"].active { background: #fff; }
        .filter-btn[data-filter="Stage"].active { background: #f1e3b6; }
        .filter-btn[data-filter="Nightmare"].active { background: #d2ade6; }

        .stage-card {
            background: #161616; border-radius: 12px; margin-bottom: 30px;
            overflow: hidden; border: 1px solid #333;
            transition: transform 0.3s, opacity 0.3s;
        }
        .stage-card:hover { border-color: #555; transform: translateY(-5px); }

        .header-stage { background: linear-gradient(90deg, rgba(241, 227, 182, 0.1), transparent); border-left: 5px solid #f1e3b6; }
        .header-nightmare { background: linear-gradient(90deg, rgba(210, 173, 230, 0.1), transparent); border-left: 5px solid #d2ade6; }
        
        .stage-header { padding: 15px 25px; display: flex; align-items: center; gap: 15px; }
        .stage-number { font-size: 1.8rem; font-weight: 800; color: #fff; letter-spacing: 1px; }
        .stage-badge { 
            padding: 4px 12px; border-radius: 6px; font-size: 0.75rem; 
            font-weight: bold; text-transform: uppercase; letter-spacing: 1px; 
        }
        .badge-stage { background: #f1e3b6; color: #3d3314; }
        .badge-nightmare { background: #d2ade6; color: #2e1a3b; }

        .team-row {
            padding: 20px 25px; border-top: 1px solid #2a2a2a;
            display: flex; flex-wrap: wrap; gap: 20px; align-items: center;
        }
        
        .formation-info { width: 60px; text-align: center; opacity: 0.8; }
        .formation-info img { width: 35px; margin-bottom: 5px; }
        .formation-info span { font-size: 0.8rem; color: #888; }

        .heroes-container { flex-grow: 1; display: flex; gap: 10px; align-items: center; min-height: 70px; }
        .hero-slot {
            width: 55px; aspect-ratio: 3/4; background: #000; border: 1px solid #333;
            border-radius: 6px; overflow: hidden; position: relative; transition: all 0.3s;
        }
        .hero-slot img { width: 100%; height: 100%; object-fit: cover; }
        .hero-slot.is-front { 
            border-color: #90caf9; transform: translateY(-12px); 
            box-shadow: 0 5px 15px rgba(144, 202, 249, 0.2); z-index: 2;
        }

        .desc-box { 
            width: 100%; max-width: 400px; 
            background: rgba(255,255,255,0.03); border-radius: 8px; padding: 10px 15px;
            font-size: 0.9rem; color: #ccc; border-left: 3px solid #444;
        }

        .btn-export {
            background: #222; color: #fff; border: 1px solid #444;
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s; cursor: pointer; margin-left: auto;
        }
        .btn-export:hover { background: #ffc107; color: #000; border-color: #ffc107; }

        /* --- Capture Canvas Styles --- */
        #captureArea {
            position: fixed; top: -9999px; left: -9999px;
            width: 600px; background: #121212; padding: 0;
            z-index: -9999;
        }
        
        .capture-header { 
            padding: 20px 30px; display: flex; justify-content: space-between; align-items: center;
            position: relative; z-index: 1; 
        }
        
        .capture-body { 
            padding: 50px 30px 40px 30px;
            background: #1a1a1a; 
            display: flex; justify-content: center; gap: 15px; align-items: flex-end;
            position: relative; z-index: 50;
        }

        /* [NEW] Description Area in Capture */
        .capture-desc {
            background: #1a1a1a; /* สีเดียวกับ Body */
            color: #d0d0d0;
            padding: 0 40px 30px 40px;
            text-align: center;
            font-size: 1rem;
            font-style: italic;
            position: relative; 
            z-index: 50;
        }
        
        .capture-hero { 
            width: 70px; aspect-ratio: 3/4; 
            border: 2px solid #ef9a9a; 
            border-radius: 6px;
            position: relative; 
            z-index: 2;
            background: #000;
        }
        
        .capture-hero img { 
            width: 100%; height: 100%; object-fit: cover; 
            border-radius: 4px; 
            position: relative; 
            z-index: 5; 
            display: block;
        }
        
        .capture-hero.front { 
            border-color: #90caf9; 
            top: -30px; 
            box-shadow: 0 15px 30px rgba(0,0,0,0.6); 
            z-index: 100 !important; 
        }
        
        .capture-footer { 
            padding: 10px; text-align: center; font-size: 0.8rem; color: #555; background: #121212;
            position: relative; z-index: 10;
        }

    </style>
</head>
<body class="d-flex flex-column h-100 bg-main text-light">
    
    <%- include('../partials/navbar') %>

    <main class="flex-shrink-0 mt-5 pt-4">
        <div class="container py-5">
            <div class="text-center mb-5">
                <h1 class="display-4 fw-bold text-gradient">Stage & Nightmare</h1>
                <p class="text-secondary">Recommended team compositions and strategies</p>
            </div>
            <div class="filter-container">
                <button class="filter-btn active" data-filter="all" onclick="filterStages('all', this)">All</button>
                <button class="filter-btn" data-filter="Stage" onclick="filterStages('Stage', this)">Stage</button>
                <button class="filter-btn" data-filter="Nightmare" onclick="filterStages('Nightmare', this)">Nightmare</button>
            </div>

            <div id="stagesContainer">
                <% stages.forEach(group => { %>
                    <div class="stage-card filter-item" data-type="<%= group.type %>">
                        <div class="stage-header header-<%= group.type.toLowerCase() %>">
                            <span class="stage-number"><%= group.stage_main %> - <%= group.stage_sub %></span>
                            <span class="stage-badge badge-<%= group.type.toLowerCase() %>"><%= group.type %></span>
                        </div>
                        <% group.teams.forEach(team => { %>
                            <div class="team-row">
                                <div class="formation-info">
                                    <img src="/images/formation/<%= team.formation %>.png">
                                    <span><%= team.formation %></span>
                                </div>
                                <div class="heroes-container">
                                    <% 
                                        let upIndices = [];
                                        if(team.formation === '1-4') upIndices = [2];
                                        else if(team.formation === '2-3') upIndices = [1, 3];
                                        else if(team.formation === '3-2') upIndices = [0, 2, 4];
                                        else if(team.formation === '4-1') upIndices = [0, 1, 3, 4];
                                    %>
                                    <% team.heroes.forEach((h, i) => { %>
                                        <div class="hero-slot <%= upIndices.includes(i) ? 'is-front' : '' %>">
                                            <% if(h) { %> <img src="/images/heroes/<%= h %>"> <% } %>
                                        </div>
                                    <% }) %>
                                </div>
                                <% if(team.description) { %>
                                    <div class="desc-box"><i class="bi bi-info-circle me-2 text-warning"></i><%= team.description %></div>
                                <% } %>
                                <button class="btn-export" onclick='exportTeam(<%- JSON.stringify(team) %>, "<%= group.type %>")' title="Export Image">
                                    <i class="bi bi-camera"></i>
                                </button>
                            </div>
                        <% }) %>
                    </div>
                <% }) %>
                <% if(stages.length === 0) { %>
                    <div class="text-center py-5 text-muted"><i class="bi bi-inbox display-1"></i><p class="mt-3">No guides available yet.</p></div>
                <% } %>
            </div>
        </div>
    </main>

    <div id="captureArea">
        <div class="capture-header" id="capHeader">
            <div>
                <h1 style="margin:0; font-size: 2.5rem; font-weight:800; color:#fff;" id="capStage">20 - 30</h1>
                <span id="capTypeBadge" style="background:#fff; color:#000; padding:2px 10px; border-radius:4px; font-weight:bold; font-size:0.9rem;">STAGE</span>
            </div>
            <div style="text-align:right;">
                <div style="font-size:1.2rem; color:#fff; font-weight:bold;">7K Rebirth</div>
                <div style="font-size:0.8rem; color:#888;">Database Guide</div>
            </div>
        </div>
        
        <div class="capture-body" id="capHeroes">
            </div>

        <div class="capture-desc" id="capDesc" style="display: none;">
            </div>

        <div class="capture-footer">
            Generated by 7K Rebirth Database
        </div>
    </div>

    <%- include('../partials/footer') %>

    <script>
        function filterStages(type, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const items = document.querySelectorAll('.filter-item');
            items.forEach(item => {
                if (type === 'all' || item.dataset.type === type) {
                    item.style.display = 'block';
                    item.style.opacity = '0';
                    item.style.transform = 'translateY(10px)';
                    setTimeout(() => { item.style.opacity = '1'; item.style.transform = 'translateY(0)'; }, 50);
                } else { item.style.display = 'none'; }
            });
        }

        function exportTeam(teamData, type) {
            const capture = document.getElementById('captureArea');
            const capHeader = document.getElementById('capHeader');
            const capStage = document.getElementById('capStage');
            const capBadge = document.getElementById('capTypeBadge');
            const capHeroes = document.getElementById('capHeroes');
            const capDesc = document.getElementById('capDesc'); // [NEW]

            // Setup Data
            capStage.innerText = `${teamData.stage_main} - ${teamData.stage_sub}`;
            capBadge.innerText = type.toUpperCase();

            // [NEW] Description Logic
            if (teamData.description && teamData.description.trim() !== "") {
                capDesc.style.display = 'block';
                capDesc.innerHTML = `<i class="bi bi-quote me-2 text-warning"></i>${teamData.description}`;
            } else {
                capDesc.style.display = 'none';
            }

            // Theme Styling
            if (type === 'Stage') {
                capHeader.style.background = '#f1e3b6';
                capStage.style.color = '#3d3314';
                capBadge.style.background = '#3d3314';
                capBadge.style.color = '#f1e3b6';
            } else {
                capHeader.style.background = '#d2ade6';
                capStage.style.color = '#2e1a3b';
                capBadge.style.background = '#2e1a3b';
                capBadge.style.color = '#d2ade6';
            }

            // Hero Logic
            let upIndices = [];
            if(teamData.formation === '1-4') upIndices = [2];
            else if(teamData.formation === '2-3') upIndices = [1, 3];
            else if(teamData.formation === '3-2') upIndices = [0, 2, 4];
            else if(teamData.formation === '4-1') upIndices = [0, 1, 3, 4];

            let html = '';
            let imagesToLoad = 0;
            
            teamData.heroes.forEach((h, i) => {
                if(h) {
                    imagesToLoad++;
                    const isFront = upIndices.includes(i) ? 'front' : '';
                    html += `
                        <div class="capture-hero ${isFront}">
                            <img src="/images/heroes/${h}" onload="checkImages()">
                        </div>
                    `;
                }
            });
            capHeroes.innerHTML = html;

            let loadedImages = 0;
            window.checkImages = function() {
                loadedImages++;
            }

            setTimeout(() => {
                html2canvas(capture, {
                    backgroundColor: '#121212',
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    onclone: (clonedDoc) => {
                        const clonedBody = clonedDoc.getElementById('capHeroes');
                        clonedBody.style.display = 'flex';
                        
                        // Ensure Description is visible in clone if needed
                        const clonedDesc = clonedDoc.getElementById('capDesc');
                        if (teamData.description && teamData.description.trim() !== "") {
                            clonedDesc.style.display = 'block';
                        }
                    }
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `7K-${type}-${teamData.stage_main}-${teamData.stage_sub}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                });
            }, 500);
        }
    </script>
</body>
</html>