<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../../partials/head') %>
    <style>
        /* --- Global & Layout --- */
        body { background-color: #0f0f0f; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        
        /* Layout Calculation: Navbar Height = 64px */
        .build-layout { 
            display: flex; 
            height: 100vh; 
            padding-top: 64px; 
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #666; }

        /* --- Modern Admin Navbar --- */
        .navbar-modern {
            height: 64px;
            background: rgba(18, 18, 18, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: fixed; top: 0; left: 0; right: 0; z-index: 1050;
            padding: 0 20px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .nav-brand-text { font-weight: 700; letter-spacing: 0.5px; font-size: 1.1rem; color: #fff; }
        .nav-brand-icon { color: #ffc107; font-size: 1.2rem; margin-right: 8px; }
        .nav-badge { background: linear-gradient(45deg, #ffc107, #ff8c00); color: #000; font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; margin-left: 8px; font-weight: bold; }
        
        .nav-btn {
            background: rgba(255, 255, 255, 0.05);
            color: #ccc;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex; align-items: center; gap: 6px;
        }
        .nav-btn:hover { background: rgba(255, 255, 255, 0.1); color: #fff; border-color: rgba(255, 255, 255, 0.3); }
        .nav-btn.primary { background: rgba(255, 193, 7, 0.1); color: #ffc107; border-color: rgba(255, 193, 7, 0.3); }
        .nav-btn.primary:hover { background: rgba(255, 193, 7, 0.2); box-shadow: 0 0 10px rgba(255, 193, 7, 0.2); }

        /* --- Left Sidebar (Heroes) --- */
        .hero-panel { 
            width: 280px; background: #161616; border-right: 1px solid #333; 
            display: flex; flex-direction: column; flex-shrink: 0; 
        }
        .hero-search-box { padding: 15px; border-bottom: 1px solid #2a2a2a; }
        .hero-list { overflow-y: auto; flex: 1; padding: 10px; }
        .hero-item { 
            display: flex; align-items: center; padding: 12px; margin-bottom: 6px;
            cursor: pointer; border-radius: 8px; transition: all 0.2s; border: 1px solid transparent;
        }
        .hero-item:hover { background: #252525; }
        .hero-item.active { background: #2a2a2a; border-color: #ffc107; box-shadow: inset 4px 0 0 #ffc107; }
        .hero-item img { 
            width: 45px; aspect-ratio: 3/4; object-fit: cover; border-radius: 4px; 
            margin-right: 12px; background: #000; border: 1px solid #444;
        }

        /* --- Right Content (Builds) --- */
        .build-panel { flex: 1; background: #121212; overflow-y: auto; padding: 30px 20px; position: relative; scroll-behavior: smooth; }

        /* --- Build Card --- */
        .build-card { 
            background: #1e1e1e; border: 1px solid #333; border-radius: 10px; 
            padding: 20px; margin-bottom: 25px; position: relative; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            max-width: 850px; margin-left: auto; margin-right: auto;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .btn-delete-card { 
            position: absolute; top: 15px; right: 15px; 
            color: #666; transition: 0.2s; background: none; border: none; font-size: 1.1rem;
        }
        .btn-delete-card:hover { color: #dc3545; transform: scale(1.1); }

        /* C-Level Dropdown (Hover Effect) */
        .clevel-select {
            background-color: #000;
            color: #ffc107;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 4px 10px;
            font-size: 0.85rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            width: auto;
            min-width: 80px;
        }
        .clevel-select:hover {
            border-color: #ffc107;
            box-shadow: 0 0 8px rgba(255, 193, 7, 0.2);
            background-color: #1a1a1a;
        }
        .clevel-select:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(255, 193, 7, 0.4);
        }

        /* Segment Box (Mode) */
        .segment-box { background: #000; padding: 3px; border-radius: 6px; display: inline-flex; border: 1px solid #333; }
        .segment-box label { 
            padding: 5px 12px; cursor: pointer; color: #888; border-radius: 4px; 
            font-size: 0.8rem; font-weight: 600; transition: 0.2s; margin: 0;
        }
        .segment-box input:checked + label { background: #ffc107; color: #000; }
        .segment-box input { display: none; }

        /* Item Grid */
        .item-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .item-box { 
            background: #181818; padding: 12px; border-radius: 8px; border: 1px solid #2d2d2d; 
            display: flex; gap: 12px; align-items: center;
        }
        
        .img-picker {
            width: 60px; height: 60px; background: #080808; border: 1px dashed #555; border-radius: 8px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            overflow: hidden; position: relative; transition: 0.2s; flex-shrink: 0;
        }
        .img-picker:hover { border-color: #ffc107; color: #ffc107; }
        .img-picker img { width: 100%; height: 100%; object-fit: contain; padding: 4px; }
        .img-picker i { font-size: 1.4rem; color: #444; }

        .custom-select {
            background-color: #222; color: #eee; border: 1px solid #444; 
            border-radius: 6px; padding: 6px 10px; width: 100%; font-size: 0.85rem;
        }
        .custom-select:focus { outline: none; border-color: #ffc107; }

        .chip-container { display: flex; flex-wrap: wrap; gap: 8px; }
        .chip {
            background: #252525; border: 1px solid #444; color: #aaa; padding: 4px 12px; 
            border-radius: 20px; font-size: 0.8rem; cursor: pointer; user-select: none; transition: 0.2s;
        }
        .chip:hover { border-color: #999; color: #fff; }
        .chip.selected { background: rgba(255, 193, 7, 0.15); border-color: #ffc107; color: #ffc107; }

        /* Modal Gallery */
        .modal-gallery {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 10px;
            max-height: 400px; overflow-y: auto; padding: 10px;
        }
        .gallery-item {
            aspect-ratio: 1; border: 1px solid #333; border-radius: 6px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; background: #000;
        }
        .gallery-item:hover { border-color: #ffc107; transform: translateY(-2px); }
        .gallery-item img { max-width: 100%; max-height: 100%; padding: 5px; }
        .gallery-item.selected { border: 2px solid #ffc107; }
        .acc-mini-thumb { width: 40px; height: 40px; border: 1px solid #444; border-radius: 4px; background: #000; object-fit: contain; padding: 2px;}
    </style>
</head>
<body class="text-light">
    
    <nav class="navbar-modern">
        <div class="d-flex align-items-center">
            <i class="bi bi-shield-shaded nav-brand-icon"></i>
            <span class="nav-brand-text">7K Rebirth <span style="font-weight:400; opacity:0.7;">| Build Manager</span></span>
            <span class="nav-badge"><%= grade.toUpperCase() %></span>
        </div>
        <div class="d-flex align-items-center gap-3">
            <a href="/admin/dashboard" class="nav-btn primary">
                <i class="bi bi-grid-fill"></i> Dashboard
            </a>
            <a href="/admin/logout" class="nav-btn">
                <i class="bi bi-box-arrow-right"></i> Logout
            </a>
        </div>
    </nav>

    <div class="build-layout">
        <div class="hero-panel">
            <div class="hero-search-box">
                <div class="input-group input-group-sm">
                    <span class="input-group-text bg-dark border-secondary text-secondary"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control bg-dark text-light border-secondary" placeholder="Search Hero..." id="searchHero">
                </div>
            </div>
            <div class="hero-list" id="heroListContainer">
                <% heroes.forEach(hero => { %>
                    <div class="hero-item" onclick="selectHero('<%= hero.filename %>', '<%= hero.name %>')" data-name="<%= hero.name.toLowerCase() %>">
                        <img src="/images/heroes/<%= hero.filename %>">
                        <div>
                            <div class="fw-bold text-white" style="font-size: 0.9rem;"><%= hero.name %></div>
                        </div>
                    </div>
                <% }) %>
            </div>
        </div>

        <div class="build-panel" id="buildPanel">
            <div id="emptyState" class="d-flex flex-column align-items-center justify-content-center h-100 text-white opacity-50">
                <i class="bi bi-person-gear display-1 mb-4"></i>
                <h5>Select a Hero to manage builds</h5>
            </div>

            <div id="editorContent" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4 sticky-top pt-2 pb-3" style="background: #121212; z-index: 10; border-bottom: 1px solid #222;">
                    <div class="d-flex align-items-center gap-3">
                        <img id="headerHeroImg" src="" style="width: 45px; aspect-ratio: 3/4; object-fit: cover; border-radius: 6px; border: 1px solid #555;">
                        <div>
                            <h4 id="selectedHeroName" class="m-0 text-white">Hero Name</h4>
                            <small class="text-secondary">Manage recommended items & stats</small>
                        </div>
                    </div>
                    <button class="btn btn-warning btn-sm fw-bold px-3 shadow-sm" onclick="createBuildCard(null, true)">
                        <i class="bi bi-plus-lg"></i> Add Build
                    </button>
                </div>

                <div id="buildsContainer">
                    </div>
                
                <div style="height: 50px;"></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="imagePickerModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content bg-dark border-secondary">
                <div class="modal-header border-secondary py-2">
                    <h6 class="modal-title text-warning"><i class="bi bi-images me-2"></i>Select Item Image</h6>
                    <button type="button" class="btn-close btn-close-white btn-sm" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" class="form-control bg-black text-light border-secondary form-control-sm" id="gallerySearch" placeholder="Filter by filename...">
                    </div>
                    <div class="modal-gallery" id="modalGalleryContent"></div>
                </div>
                <div class="modal-footer border-secondary py-1">
                    <button type="button" class="btn btn-warning btn-sm d-none" id="btnMultiConfirm">Confirm Selection</button>
                </div>
            </div>
        </div>
    </div>

    <template id="buildCardTemplate">
        <div class="build-card" data-id="">
            <button class="btn-delete-card" onclick="deleteBuild(this)" title="Delete Build"><i class="bi bi-trash"></i></button>
            
            <div class="row g-3 mb-4 align-items-end">
                <div class="col-md-5">
                    <label class="text-secondary small mb-1 fw-bold">Build Name</label>
                    <input type="text" class="form-control form-control-sm bg-dark text-light border-secondary field-name" placeholder="e.g. PVP Speed Meta">
                </div>
                <div class="col-md-7 d-flex gap-3 align-items-end">
                    <div>
                        <label class="text-secondary small mb-1 d-block fw-bold">C Level</label>
                        <select class="clevel-select field-clevel">
                            <option value="C0">C0</option>
                            <option value="C1">C1</option>
                            <option value="C2">C2</option>
                            <option value="C3">C3</option>
                            <option value="C4">C4</option>
                            <option value="C5">C5</option>
                            <option value="C6">C6</option>
                        </select>
                    </div>
                    <div>
                        <div class="segment-box field-mode">
                            <input type="radio" name="md_TMP" value="PVE" checked><label>PVE</label>
                            <input type="radio" name="md_TMP" value="PVP"><label>PVP</label>
                            <input type="radio" name="md_TMP" value="PVE&PVP"><label>PVE&PVP</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="item-grid">
                <div class="item-box">
                    <div class="img-picker" onclick="openPicker(this, 'weapon')">
                        <i class="bi bi-plus-lg"></i>
                        <img src="" class="d-none preview-img">
                        <input type="hidden" class="field-w1-img">
                    </div>
                    <div class="flex-grow-1">
                        <label class="text-warning small mb-1 d-block fw-bold">Weapon</label>
                        <select class="custom-select field-w1-stat">
                            <% const wStats = ['Weakness Hit Chance','Crit Rate','Crit Damage','All Attack (%)','All Attack','Defense (%)','Defense','HP (%)','HP','Effect Hit Rate']; %>
                            <% wStats.forEach(s => { %><option value="<%= s %>"><%= s %></option><% }) %>
                        </select>
                    </div>
                </div>
                <div class="item-box">
                    <div class="img-picker" onclick="openPicker(this, 'armor')">
                        <i class="bi bi-plus-lg"></i>
                        <img src="" class="d-none preview-img">
                        <input type="hidden" class="field-a1-img">
                    </div>
                    <div class="flex-grow-1">
                        <label class="text-info small mb-1 d-block fw-bold">Armor</label>
                        <select class="custom-select field-a1-stat">
                            <% const aStats = ['Damage Taken Reduction','Block Rate','All Attack (%)','All Attack','Defense (%)','Defense','HP (%)','HP','Effect Resistance']; %>
                            <% aStats.forEach(s => { %><option value="<%= s %>"><%= s %></option><% }) %>
                        </select>
                    </div>
                </div>
                <div class="item-box">
                    <div class="img-picker" onclick="openPicker(this, 'weapon')">
                        <i class="bi bi-plus-lg"></i>
                        <img src="" class="d-none preview-img">
                        <input type="hidden" class="field-w2-img">
                    </div>
                    <div class="flex-grow-1">
                        <label class="text-warning small mb-1 d-block fw-bold">Weapon</label>
                        <select class="custom-select field-w2-stat">
                            <% wStats.forEach(s => { %><option value="<%= s %>"><%= s %></option><% }) %>
                        </select>
                    </div>
                </div>
                <div class="item-box">
                    <div class="img-picker" onclick="openPicker(this, 'armor')">
                        <i class="bi bi-plus-lg"></i>
                        <img src="" class="d-none preview-img">
                        <input type="hidden" class="field-a2-img">
                    </div>
                    <div class="flex-grow-1">
                        <label class="text-info small mb-1 d-block fw-bold">Armor</label>
                        <select class="custom-select field-a2-stat">
                            <% aStats.forEach(s => { %><option value="<%= s %>"><%= s %></option><% }) %>
                        </select>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label class="text-secondary small mb-2 fw-bold">Accessories (Max 5)</label>
                <div class="d-flex align-items-center gap-3 p-2 bg-dark rounded border border-secondary">
                    <div class="img-picker" onclick="openPicker(this, 'accessories', true)" style="width: 45px; height: 45px;">
                        <i class="bi bi-plus-lg" style="font-size: 1rem;"></i>
                    </div>
                    <div class="acc-preview-list flex-grow-1 d-flex flex-wrap gap-2"></div>
                    <input type="hidden" class="field-acc">
                </div>
            </div>

            <div class="mb-3">
                <label class="text-secondary small mb-2 fw-bold">Sub Stats Priority</label>
                <div class="chip-container field-substats-container">
                    <% const subStats = ['All Attack (%)','All Attack','Defense (%)','Defense','HP (%)','HP','Speed','Crit Rate','Crit Damage','Weakness Hit Chance','Block Rate','Effect Hit Rate','Effect Resistance']; %>
                    <% subStats.forEach(s => { %>
                        <div class="chip"><%= s %></div>
                    <% }) %>
                </div>
                <input type="hidden" class="field-substats-input">
            </div>

            <div class="mb-3">
                <input type="text" class="form-control form-control-sm bg-dark text-light border-secondary field-desc" placeholder="Note / Description (Optional)">
            </div>

            <div class="text-end border-top border-secondary pt-3 mt-2">
                <button class="btn btn-sm btn-success px-4 fw-bold" onclick="saveCard(this)">
                    <i class="bi bi-save me-1"></i> Save Changes
                </button>
            </div>
        </div>
    </template>

    <%- include('../../partials/footer') %>

    <script>
        // Local Data Cache
        let buildsData = <%- JSON.stringify(buildsMap) %>;
        const itemImages = <%- JSON.stringify(itemImages) %>; 
        
        let currentHeroFilename = null;
        let currentPickerTarget = null;
        let isMultiSelect = false;
        let selectedMultiImages = [];

        function selectHero(filename, name) {
            currentHeroFilename = filename;
            
            document.getElementById('selectedHeroName').innerText = name;
            document.getElementById('headerHeroImg').src = `/images/heroes/${filename}`;
            
            // --- FIX: ซ่อน Empty State ทันที ---
            document.getElementById('emptyState').classList.add('d-none');
            document.getElementById('emptyState').classList.remove('d-flex');
            
            document.getElementById('editorContent').style.display = 'block';

            document.querySelectorAll('.hero-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');

            const builds = buildsData[filename] || [];
            const container = document.getElementById('buildsContainer');
            container.innerHTML = ''; 

            if (builds.length === 0) {
                createBuildCard(null, false);
            } else {
                builds.forEach(b => createBuildCard(b, false));
            }

            const panel = document.getElementById('buildPanel');
            setTimeout(() => { panel.scrollTop = 0; }, 10);
        }

        function createBuildCard(data = null, scrollToBottom = false) {
            const template = document.getElementById('buildCardTemplate');
            const clone = template.content.cloneNode(true);
            const card = clone.querySelector('.build-card');
            const uid = Date.now() + Math.random().toString(36).substr(2, 5);

            // Fix Radios (Mode only)
            const fixRadios = (tmpName, realName, val) => {
                card.querySelectorAll(`input[name="${tmpName}"]`).forEach(r => {
                    const newId = `${realName}_${r.value}_${uid}`;
                    r.name = `${realName}_${uid}`;
                    r.id = newId;
                    r.nextElementSibling.setAttribute('for', newId);
                    if (val && r.value === val) r.checked = true;
                });
            };
            fixRadios('md_TMP', 'mode', data?.mode || 'PVE');

            // Fill Inputs
            if (data) {
                card.dataset.id = data.id;
                card.querySelector('.field-name').value = data.build_name || '';
                card.querySelector('.field-desc').value = data.description || '';
                
                // Set C-Level (Dropdown)
                card.querySelector('.field-clevel').value = data.c_level || 'C0';
                
                card.querySelector('.field-w1-stat').value = data.weapon1_stat;
                card.querySelector('.field-a1-stat').value = data.armor1_stat;
                card.querySelector('.field-w2-stat').value = data.weapon2_stat;
                card.querySelector('.field-a2-stat').value = data.armor2_stat;

                setImgInput(card.querySelector('.field-w1-img'), data.weapon1_img, 'Items/weapon');
                setImgInput(card.querySelector('.field-a1-img'), data.armor1_img, 'Items/armor');
                setImgInput(card.querySelector('.field-w2-img'), data.weapon2_img, 'Items/weapon');
                setImgInput(card.querySelector('.field-a2-img'), data.armor2_img, 'Items/armor');

                const accInput = card.querySelector('.field-acc');
                accInput.value = (data.accessories || []).join(',');
                updateAccPreview(accInput, data.accessories || []);
            }

            // Chips
            const chipContainer = card.querySelector('.field-substats-container');
            const chips = chipContainer.querySelectorAll('.chip');
            const hiddenSub = card.querySelector('.field-substats-input');
            let selectedStats = data ? (data.substats || []) : [];

            const updateChips = () => {
                chips.forEach(c => {
                    c.classList.remove('selected');
                    const idx = selectedStats.indexOf(c.innerText);
                    if(idx > -1) c.classList.add('selected');
                });
                hiddenSub.value = JSON.stringify(selectedStats);
            };

            chips.forEach(c => {
                c.addEventListener('click', () => {
                    const txt = c.innerText;
                    const idx = selectedStats.indexOf(txt);
                    if(idx > -1) selectedStats.splice(idx, 1);
                    else selectedStats.push(txt);
                    updateChips();
                });
            });
            updateChips();

            document.getElementById('buildsContainer').appendChild(card);
            
            if(scrollToBottom) {
                setTimeout(() => card.scrollIntoView({behavior:'smooth', block:'center'}), 100);
            }
        }

        function setImgInput(input, filename, folder) {
            if(!filename) return;
            input.value = filename;
            const preview = input.parentElement.querySelector('.preview-img');
            const icon = input.parentElement.querySelector('i');
            preview.src = `/images/${folder}/${filename}`;
            preview.classList.remove('d-none');
            icon.classList.add('d-none');
        }

        // --- Picker Logic ---
        const modal = new bootstrap.Modal(document.getElementById('imagePickerModal'));
        const galleryContent = document.getElementById('modalGalleryContent');
        const gallerySearch = document.getElementById('gallerySearch');
        const btnMultiConfirm = document.getElementById('btnMultiConfirm');

        window.openPicker = function(el, type, multi = false) {
            currentPickerTarget = el;
            isMultiSelect = multi;
            gallerySearch.value = '';
            
            let images = [];
            let folder = '';
            if(type === 'weapon') { images = itemImages.weapons; folder = 'Items/weapon'; }
            else if(type === 'armor') { images = itemImages.armors; folder = 'Items/armor'; }
            else { images = itemImages.accessories; folder = 'Items/accessories'; }

            if(multi) {
                btnMultiConfirm.classList.remove('d-none');
                const hiddenVal = el.parentElement.querySelector('.field-acc').value;
                selectedMultiImages = hiddenVal ? hiddenVal.split(',') : [];
            } else {
                btnMultiConfirm.classList.add('d-none');
                selectedMultiImages = [];
            }

            renderGallery(images, folder);
            modal.show();
            
            setTimeout(() => gallerySearch.focus(), 500);

            gallerySearch.onkeyup = (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = images.filter(img => img.toLowerCase().includes(term));
                renderGallery(filtered, folder);
            };
        }

        function renderGallery(images, folder) {
            galleryContent.innerHTML = '';
            images.forEach(img => {
                const div = document.createElement('div');
                div.className = 'gallery-item';
                if(isMultiSelect && selectedMultiImages.includes(img)) div.classList.add('selected');
                div.innerHTML = `<img src="/images/${folder}/${img}">`;
                div.onclick = () => {
                    if(isMultiSelect) {
                        if(selectedMultiImages.includes(img)) {
                            selectedMultiImages = selectedMultiImages.filter(i => i !== img);
                            div.classList.remove('selected');
                        } else {
                            if(selectedMultiImages.length >= 5) return alert('Max 5 accessories');
                            selectedMultiImages.push(img);
                            div.classList.add('selected');
                        }
                    } else {
                        selectImageSingle(img, folder);
                    }
                };
                galleryContent.appendChild(div);
            });
        }

        function selectImageSingle(filename, folder) {
            const input = currentPickerTarget.querySelector('input');
            const preview = currentPickerTarget.querySelector('.preview-img');
            const icon = currentPickerTarget.querySelector('i');
            input.value = filename;
            preview.src = `/images/${folder}/${filename}`;
            preview.classList.remove('d-none');
            icon.classList.add('d-none');
            modal.hide();
        }

        btnMultiConfirm.onclick = () => {
            const input = currentPickerTarget.parentElement.querySelector('.field-acc');
            input.value = selectedMultiImages.join(',');
            updateAccPreview(input, selectedMultiImages);
            modal.hide();
        };

        function updateAccPreview(input, images) {
            const container = input.parentElement.querySelector('.acc-preview-list');
            container.innerHTML = '';
            images.forEach(img => {
                if(!img) return;
                const thumb = document.createElement('img');
                thumb.src = `/images/Items/accessories/${img}`;
                thumb.className = 'acc-mini-thumb';
                container.appendChild(thumb);
            });
        }

        window.saveCard = function(btn) {
            const card = btn.closest('.build-card');
            const uid = card.querySelector('input[type="radio"]').name.split('_').pop();
            const getRadio = (n) => card.querySelector(`input[name="${n}_${uid}"]:checked`)?.value;

            const payload = {
                id: card.dataset.id || null,
                hero_filename: currentHeroFilename,
                build_name: card.querySelector('.field-name').value,
                
                // Get C-Level from Select
                c_level: card.querySelector('.field-clevel').value,
                
                mode: getRadio('mode'),
                
                weapon1_img: card.querySelector('.field-w1-img').value,
                weapon1_stat: card.querySelector('.field-w1-stat').value,
                armor1_img: card.querySelector('.field-a1-img').value,
                armor1_stat: card.querySelector('.field-a1-stat').value,
                
                weapon2_img: card.querySelector('.field-w2-img').value,
                weapon2_stat: card.querySelector('.field-w2-stat').value,
                armor2_img: card.querySelector('.field-a2-img').value,
                armor2_stat: card.querySelector('.field-a2-stat').value,

                accessories: card.querySelector('.field-acc').value.split(',').filter(x=>x),
                substats: JSON.parse(card.querySelector('.field-substats-input').value || '[]'),
                description: card.querySelector('.field-desc').value
            };

            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';
            
            fetch('/admin/api/save_build', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    btn.innerHTML = '<i class="bi bi-check2-circle"></i> Saved';
                    btn.classList.replace('btn-success', 'btn-outline-success');
                    
                    card.dataset.id = data.id;
                    payload.id = data.id;
                    
                    if (!buildsData[currentHeroFilename]) buildsData[currentHeroFilename] = [];
                    const idx = buildsData[currentHeroFilename].findIndex(b => b.id == data.id);
                    if (idx > -1) buildsData[currentHeroFilename][idx] = payload;
                    else buildsData[currentHeroFilename].push(payload);

                    setTimeout(() => {
                        btn.innerHTML = originalHTML;
                        btn.classList.replace('btn-outline-success', 'btn-success');
                    }, 1500);
                } else alert('Error: ' + data.error);
            });
        }

        window.deleteBuild = function(btn) {
            if(!confirm('Delete this build?')) return;
            const card = btn.closest('.build-card');
            const id = card.dataset.id;
            
            card.remove();
            
            if(id) {
                fetch('/admin/api/delete_build', { method: 'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id}) });
                if (buildsData[currentHeroFilename]) {
                    buildsData[currentHeroFilename] = buildsData[currentHeroFilename].filter(b => b.id != id);
                }
            }
        }

        document.getElementById('searchHero').addEventListener('keyup', (e) => {
            const term = e.target.value.toLowerCase();
            document.querySelectorAll('.hero-item').forEach(el => {
                el.style.display = el.dataset.name.includes(term) ? 'flex' : 'none';
            });
        });
    </script>
</body>
</html>