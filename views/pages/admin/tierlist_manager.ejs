<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../../partials/head') %>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        body { 
            background-color: #0f0f0f; 
            font-family: 'Segoe UI', sans-serif;
            scrollbar-width: thin;
            scrollbar-color: #444 #121212;
            /* ป้องกันการเลือกข้อความทั้งหน้าเวลาเผลอลากไปโดน */
            user-select: none; 
            -webkit-user-select: none;
        }

        /* --- Navbar Modern --- */
        .navbar-modern {
            height: 64px; 
            background: rgba(18, 18, 18, 0.95); 
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
            position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
            padding: 0 20px; 
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        
        .nav-brand-box { display: flex; align-items: center; gap: 12px; }
        .site-logo { height: 40px; width: auto; object-fit: contain; filter: drop-shadow(0 0 5px rgba(255,193,7,0.3)); }
        .nav-title { font-weight: 700; color: #fff; font-size: 1.1rem; letter-spacing: 0.5px; }
        
        .nav-badge { 
            background: linear-gradient(135deg, #ffc107, #ff8c00); 
            color: #000; font-size: 0.75rem; padding: 3px 10px; 
            border-radius: 20px; font-weight: 800; letter-spacing: 1px;
            box-shadow: 0 0 10px rgba(255, 193, 7, 0.4);
        }

        .nav-btn { 
            background: rgba(255, 255, 255, 0.05); color: #ccc; 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            padding: 6px 16px; border-radius: 20px; 
            font-size: 0.85rem; text-decoration: none; 
            display: inline-flex; align-items: center; gap: 6px; 
            transition: all 0.2s;
        }
        .nav-btn:hover { background: rgba(255, 255, 255, 0.1); color: #fff; transform: translateY(-1px); }
        .nav-btn.primary { background: rgba(255, 193, 7, 0.1); color: #ffc107; border-color: rgba(255, 193, 7, 0.3); }
        .nav-btn.primary:hover { background: rgba(255, 193, 7, 0.2); box-shadow: 0 0 15px rgba(255, 193, 7, 0.2); }

        .cat-switcher a {
            color: #888; text-decoration: none; padding: 5px 12px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; transition: 0.2s;
        }
        .cat-switcher a:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .cat-switcher a.active { color: #000; background: #ffc107; }

        .admin-container { max-width: 1200px; margin: 0 auto; margin-top: 90px; padding-bottom: 80px; }

        /* --- Tier Row --- */
        .tier-row {
            display: flex;
            margin-bottom: 15px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            overflow: hidden;
            min-height: 140px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .tier-rank-col {
            width: 130px;
            flex-shrink: 0;
            background: linear-gradient(180deg, #151515 0%, #080808 100%);
            display: flex; align-items: center; justify-content: center;
            border-right: 1px solid #333; padding: 10px;
        }
        .tier-rank-logo {
            max-width: 90px; max-height: 80px; object-fit: contain;
            filter: drop-shadow(0 0 10px rgba(0,0,0,0.8));
            transition: transform 0.2s;
            /* ป้องกันการลากรูป Logo */
            pointer-events: none;
        }

        .tier-content {
            flex-grow: 1; padding: 15px;
            display: flex; flex-wrap: wrap; gap: 10px; align-content: flex-start;
            background-color: #1e1e1e;
            transition: background 0.3s;
        }
        .tier-content.sortable-drag-over { background-color: #252525; }

        /* --- Character Card --- */
        .char-card {
            width: 70px; aspect-ratio: 3/4; position: relative;
            border-radius: 6px; overflow: hidden; border: 2px solid #333;
            background: #222;
            transition: transform 0.1s;
            /* สำคัญ: ป้องกันการเลือกข้อความ หรือลากรูป native */
            user-select: none;
            -webkit-user-drag: none;
            cursor: grab;
        }
        .char-card:active { cursor: grabbing; }
        .char-card:hover { border-color: #666; transform: translateY(-2px); z-index: 5; }
        
        .char-card img { 
            width: 100%; height: 100%; object-fit: cover; 
            /* ป้องกัน Browser ลากรูป */
            pointer-events: none; 
            -webkit-user-drag: none;
        }
        
        .char-badge {
            position: absolute; bottom: 0; right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); 
            color: #fff; text-shadow: 1px 1px 2px #000;
            font-size: 0.65rem; padding: 2px 5px;
            width: 100%; text-align: right; font-weight: 700;
        }

        /* --- Pool Section --- */
        .pool-wrapper {
            background: #141414; border: 1px dashed #444; border-radius: 12px;
            padding: 20px; margin-top: 40px; position: relative;
        }
        .pool-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px;
        }
        .pool-section {
            min-height: 150px;
            background-image: radial-gradient(#222 1px, transparent 1px);
            background-size: 20px 20px;
            border-radius: 8px; padding: 10px;
        }

        /* Save Indicator */
        #save-indicator {
            position: fixed; bottom: 30px; right: 30px;
            background: #198754; color: white;
            padding: 12px 25px; border-radius: 30px;
            display: none; font-weight: 600; font-size: 0.9rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 1100; animation: slideUp 0.3s ease;
            border: 1px solid rgba(255,255,255,0.2);
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* --- STYLE ตอนลาก (หัวใจสำคัญของความลื่น) --- */
        .sortable-fallback {
            /* ปิด Pointer Events เพื่อให้ Mouse ทะลุไปเจอ Element ข้างล่าง ทำให้ลากลื่นมาก */
            pointer-events: none; 
            opacity: 0.9 !important;
            box-shadow: 0 20px 40px rgba(0,0,0,0.8);
            border: 2px solid #ffc107; /* ขอบทองตอนลาก */
            transform: scale(1.15) rotate(3deg); /* เอียงนิดนึงให้ดูเหมือนหยิบ */
            cursor: grabbing;
            z-index: 99999 !important;
        }
        
        /* ตัว Placeholder ที่ตำแหน่งปลายทาง */
        .sortable-ghost { 
            opacity: 0.2; 
            background: #ffc107; 
            border: 2px dashed #ffc107;
        }
        
        /* ซ่อนตัวต้นฉบับขณะลาก (ถ้าต้องการ) หรือปล่อยไว้ก็ได้ */
        .sortable-drag { opacity: 0; } 
    </style>
</head>
<body class="text-light">

    <nav class="navbar-modern">
        <div class="nav-brand-box">
            <img src="/images/about_website/logo_seven_knight_rebirth.png" alt="Logo" class="site-logo">
            <div>
                <span class="nav-title">Tier Manager</span>
                <span class="nav-badge"><%= category %></span>
            </div>
        </div>

        <div class="d-flex align-items-center gap-4">
            <div class="cat-switcher d-flex gap-1 bg-dark rounded p-1 border border-secondary">
                <a href="?category=PVP" class="<%= category === 'PVP' ? 'active' : '' %>">PVP</a>
                <a href="?category=PVE" class="<%= category === 'PVE' ? 'active' : '' %>">PVE</a>
                <a href="?category=PET" class="<%= category === 'PET' ? 'active' : '' %>">PET</a>
            </div>

            <div class="d-flex gap-2">
                <a href="/admin/dashboard" class="nav-btn primary">
                    <i class="bi bi-grid-fill"></i> Panel
                </a>
                <a href="/admin/logout" class="nav-btn">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container admin-container">
        
        <div id="tier-rows-wrapper">
            <% ranks.forEach(rank => { %>
                <div class="tier-row">
                    <div class="tier-rank-col">
                        <img src="/images/logo_tiers/<%= rank %>.png" alt="<%= rank %>" class="tier-rank-logo">
                    </div>
                    <div class="tier-content sortable-list" id="tier-<%= rank %>" data-rank="<%= rank %>">
                        <% tierData[rank].forEach(char => { %>
                            <div class="char-card" data-filename="<%= char.filename %>">
                                <img src="/images/<%= folder %>/<%= char.filename %>">
                                <span class="char-badge"><%= char.grade %></span>
                            </div>
                        <% }) %>
                    </div>
                </div>
            <% }) %>
        </div>

        <div class="pool-wrapper">
            <div class="pool-header">
                <div class="d-flex align-items-center gap-2">
                    <i class="bi bi-inbox-fill text-secondary fs-4"></i>
                    <div>
                        <h5 class="m-0 text-white">Character Pool</h5>
                        <small class="text-secondary">Drag characters from here to assign tiers</small>
                    </div>
                </div>
                <span class="badge bg-dark border border-secondary text-secondary">Unassigned</span>
            </div>
            <div class="pool-section sortable-list d-flex flex-wrap gap-2" id="pool-area" data-rank="POOL">
                <% poolData.forEach(char => { %>
                    <div class="char-card" data-filename="<%= char.filename %>">
                        <img src="/images/<%= folder %>/<%= char.filename %>">
                        <span class="char-badge"><%= char.grade %></span>
                    </div>
                <% }) %>
            </div>
        </div>

    </div>

    <div id="save-indicator"><i class="bi bi-check-circle-fill me-2"></i>All changes saved</div>

    <%- include('../../partials/footer') %>

    <script>
        const sortableLists = document.querySelectorAll('.sortable-list');
        
        sortableLists.forEach(list => {
            new Sortable(list, {
                group: 'shared', 
                animation: 250, // เพิ่ม Animation Time ให้นุ่มนวลขึ้น
                delay: 0, // ไม่ต้องรอ กดปุ๊บลากปั๊บ
                delayOnTouchOnly: true, // เฉพาะมือถือให้รอนิดนึง
                
                // --- Key Settings for Smoothness & Scrolling ---
                forceFallback: true, // ใช้ JS Drag แทน Native (จำเป็นสำหรับ Scroll Wheel)
                fallbackClass: 'sortable-fallback', // Style ตอนลาก
                fallbackOnBody: true, // ลากทะลุ Container ได้
                fallbackTolerance: 3, // ขยับเมาส์เกิน 3px ถึงจะเริ่มลาก (ป้องกันการคลิกพลาด)
                
                // --- Scroll Config ---
                scroll: true, 
                scrollSensitivity: 150, 
                scrollSpeed: 20, 
                bubbleScroll: true,
                
                // --- Visuals ---
                ghostClass: 'sortable-ghost',
                
                onEnd: function (evt) {
                    autoSave();
                }
            });
        });

        // Debounce Save
        let saveTimeout;
        function autoSave() {
            clearTimeout(saveTimeout);
            
            const indicator = document.getElementById('save-indicator');
            indicator.style.display = 'block';
            indicator.style.backgroundColor = '#0dcaf0'; 
            indicator.innerHTML = '<i class="bi bi-arrow-repeat spin me-2"></i>Saving...';

            saveTimeout = setTimeout(() => {
                const payload = [];
                const ranks = ['SSS', 'SS', 'S', 'A', 'B', 'C', 'D', 'E', 'F'];
                
                ranks.forEach(rank => {
                    const container = document.getElementById('tier-' + rank);
                    if(container) {
                        const cards = container.querySelectorAll('.char-card');
                        cards.forEach(card => {
                            payload.push({
                                filename: card.getAttribute('data-filename'),
                                rank: rank
                            });
                        });
                    }
                });

                fetch('/admin/api/save_tier', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        category: '<%= category %>',
                        data: payload
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if(data.success) {
                        indicator.style.backgroundColor = '#198754';
                        indicator.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>Saved';
                        setTimeout(() => { indicator.style.display = 'none'; }, 2000);
                    }
                })
                .catch(err => {
                    console.error(err);
                    indicator.style.backgroundColor = '#dc3545';
                    indicator.innerHTML = '<i class="bi bi-exclamation-triangle-fill me-2"></i>Error';
                });
            }, 800);
        }
    </script>
</body>
</html>